---
- name: Ensure the existence of the apps container directories
  become: yes
  file:
    path: "{{ item.value.parent_path}}"
    state: directory
    owner: "{{ item.value.owner }}"
    group: "{{ item.value.group }}"
    mode: 0745
    recurse: yes
  with_dict: "{{ symfony_apps }}"

- name: Install Symfony apps
  command: symfony new {{ item.value.dir }} {{ item.value.symfony_version }}
  args:
    chdir: "{{ item.value.parent_path }}"
    creates: "{{ item.value.dir }}"
  with_dict: "{{ symfony_apps }}"

- name: Configure the Symfony apps databases
  lineinfile: >
    dest="{{ item.value.parent_path }}/{{ item.value.dir }}/app/config/parameters.yml"
    regexp="database_name:"
    line="    database_name: '{{ item.value.mysql_database }}'"
  with_dict: "{{ symfony_apps }}"

- name: Configure the Symfony apps database users
  lineinfile: >
    dest="{{ item.value.parent_path }}/{{ item.value.dir }}/app/config/parameters.yml"
    regexp="database_user:"
    line="    database_user: '{{ item.value.mysql_user }}'"
  with_dict: "{{ symfony_apps }}"

- name: Configure the Symfony apps database user passwords
  lineinfile: >
    dest="{{ item.value.parent_path }}/{{ item.value.dir }}/app/config/parameters.yml"
    regexp="database_password:"
    line="    database_password: '{{ item.value.mysql_password }}'"
  with_dict: "{{ symfony_apps }}"

- name: Install the permission fixer script in the applications
  template:
    src: "app/permissions.sh.sf{{ item.value.symfony_version|int }}.tpl"
    dest: "{{ item.value.parent_path}}/{{ item.value.dir }}/permissions.sh"
    owner: "{{ item.value.owner }}"
    group: "{{ item.value.group }}"
    mode: 0744
  with_dict: "{{ symfony_apps }}"

- name: Run the permission fixer scripts
  become: yes
  shell: ./permissions.sh chdir="{{ item.value.parent_path}}/{{ item.value.dir }}"
  with_dict: "{{ symfony_apps }}"
